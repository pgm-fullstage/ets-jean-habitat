---
import Layout from '../layouts/Layout.astro';
import HomePageContent from '../layouts/HomePageContent.astro';

// Fetch configuration pour vérifier maintenance avant rendu
const CONFIG_URL = import.meta.env.PUBLIC_CONFIG_URL || '/ets-jean-habitat-content.json';

async function getSiteConfigAndCheck() {
  try {
    const response = await fetch(CONFIG_URL, {
      headers: { 'Cache-Control': 'max-age=300' },
      signal: AbortSignal.timeout(5000)
    });
    
    if (!response.ok || response.status >= 500) {
      return { maintenanceMode: true, siteData: null };
    }
    
    const contentType = response.headers.get('content-type');
    if (!contentType?.includes('application/json')) {
      return { maintenanceMode: true, siteData: null };
    }
    
    let data;
    try {
      data = await response.json();
    } catch {
      return { maintenanceMode: true, siteData: null };
    }
    
    // Vérification structure basique
    if (!data || !data.business || !data.ui_sections) {
      return { maintenanceMode: true, siteData: null };
    }
    
    return { maintenanceMode: false, siteData: data };
    
  } catch (error) {
    return { maintenanceMode: true, siteData: null };
  }
}

const { maintenanceMode, siteData } = await getSiteConfigAndCheck();

if (maintenanceMode) {
  return Astro.redirect('/maintenance');
}
---

<Layout siteData={siteData}>
    <HomePageContent siteData={siteData} />
</Layout>
