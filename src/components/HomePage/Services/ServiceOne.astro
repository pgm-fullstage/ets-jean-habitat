---
import Button from "../../Button.astro";

const siteData = Astro.props.siteData || (typeof window !== 'undefined' ? window.siteData : null);

if (!siteData) {
  throw new Error('siteData is required for ServiceOne component');
}

const { business, ui_sections, cities } = siteData;
const { theme, services, header } = ui_sections;

// Get current city for dynamic content
const currentCity = cities?.default || 'louannec';
const cityData = cities?.available?.[currentCity] || {
  hero_title: "Buscail Habitat Couverture à Louannec"
};

// Utiliser les services de la section services ou fallback vers la navigation
const serviceData = services || {
  section: {
    title: "Nos services",
    main_title: "Une expertise complète pour votre habitat", 
    description: "Découvrez notre gamme complète de services pour l'entretien, la rénovation et l'amélioration de votre habitat."
  },
  items: header.navigation.services
};

// Fonction pour déterminer le nombre de colonnes selon le nombre de services
const getGridClasses = (itemCount) => {
  if (itemCount <= 3) return 'grid-cols-1 md:grid-cols-2 lg:grid-cols-3';
  if (itemCount <= 4) return 'grid-cols-1 md:grid-cols-2 lg:grid-cols-4';
  if (itemCount <= 6) return 'grid-cols-1 md:grid-cols-2 lg:grid-cols-3 xl:grid-cols-3';
  return 'grid-cols-1 md:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4';
};


const gridClasses = getGridClasses(serviceData.items.length);

// Vérifier si le nombre de services est impair
const isOddCount = serviceData.items.length % 2 !== 0;
---

<div class="py-16 sm:py-24">
  <div class="mx-auto max-w-7xl px-6 lg:px-8">
    <!-- En-tête de section -->
    <div class="mx-auto max-w-2xl text-center mb-16">
      <h2 class="font-semibold text-base text-primary uppercase tracking-widest mb-3 animate-on-scroll fade-in-up" >
        {serviceData.section.title} - {cityData.hero_title}
      </h3>
      </h2>
      <h3 class="text-3xl font-bold tracking-tight text-title sm:text-4xl mb-6 animate-on-scroll fade-in-up" data-delay="100">
        {serviceData.section.main_title} 
      <p class="text-lg leading-8 animate-on-scroll fade-in-up text-text font-normal" data-delay="200">
        {serviceData.section.description}
      </p>
    </div>

    <!-- Grille des services -->
    <div class={`mx-auto grid gap-6 ${gridClasses} animate-on-scroll fade-in-bottom`} data-delay="300">
      {serviceData.items.map((service, index) => (
        <div class="group relative bg-white rounded-xl  overflow-hidden shadow-sm ring-1 ring-gray-100 hover:shadow-lg hover:ring-gray-200 transition-all duration-500 hover:-translate-y-1 cursor-pointer" id={service.anchor.replace('#', '')}>
          <!-- Image -->
          <div class="relative h-40 overflow-hidden">
            <img 
              src={service.image || `https://images.unsplash.com/photo-1504307651254-35680f356dfd?ixlib=rb-4.0.3&auto=format&fit=crop&w=800&q=80`} 
              alt={service.title}
              class="w-full h-full object-cover transition-transform duration-700 group-hover:scale-105"
            />
            <div class="absolute inset-0 bg-gradient-to-t from-black/30 to-transparent opacity-0 group-hover:opacity-100 transition-opacity duration-300"></div>
          </div>
          
          <!-- Contenu -->
          <div class="p-6 grid content-between">
            <div>

           
            <h3 class="text-base md:text-lg font-semibold mb-3 group-hover:text-primary transition-colors duration-300" style={`color: ${theme.title}`}>
              {service.title}
            </h3>
            <p class="text-sm leading-relaxed text-text">
              {service.description}
            </p>
             </div>
            <!-- Subtle hover indicator -->
            <div class=" mt-4 opacity-0 group-hover:opacity-100 transition-all duration-300 transform translate-y-2 group-hover:translate-y-0">
              <Button variant="secondary" size="xs" modal modalType="center" icon="arrow_right" iconPosition="right">En savoir plus</Button>
            </div>
          </div>
        </div>
      ))}
      
      {/* Carte CTA quand le nombre de services est impair */}
      {isOddCount && (
        <div class="group relative rounded-xl overflow-hidden shadow-sm ring-1 ring-primary/20 hover:shadow-lg hover:ring-primary/30 transition-all duration-500 hover:-translate-y-1 cursor-pointer" style={`background: ${theme.primary}`}>
          <!-- Background pattern -->
          <div class="absolute inset-0 bg-gradient-to-br from-white/10 to-transparent"></div>
          
          <!-- Contenu -->
          <div class="relative p-6 h-full flex flex-col justify-center items-center text-center min-h-[280px]">
            <div class="mb-6">
              <svg class="w-12 h-12 text-white mx-auto mb-4 opacity-90" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M8 12h.01M12 12h.01M16 12h.01M21 12c0 4.418-4.03 8-9 8a9.863 9.863 0 01-4.255-.949L3 20l1.395-3.72C3.512 15.042 3 13.574 3 12c0-4.418 4.03-8 9-8s9 3.582 9 8z"/>
              </svg>
            </div>
            
            <h3 class="text-lg md:text-xl font-bold mb-3 text-white">
              Vous avez un projet ?
            </h3>
            <p class="text-sm md:text-base leading-relaxed text-white/90 mb-6 max-w-xs">
              Discutons ensemble de vos besoins et trouvons la solution parfaite pour votre habitat.
            </p>
            
            <div class="transform group-hover:scale-105 transition-transform duration-300">
              <Button 
                variant="white" 
                size="md" 
                href={`tel:${business.contact.phone}`}
                icon="phone"
                iconPosition="left"
              >
                Nous contacter
              </Button>
            </div>
          </div>
        </div>
      )}
    </div>

    <!-- CTA Section -->
    <div class="mt-16 text-center">
      <Button 
        variant="primary" 
        icon="devis"
        size="lg" 
        radius="lg"
        modal
        modalType="center"
      >
        Demander un devis gratuit
      </Button>
    </div>
  </div>
</div>